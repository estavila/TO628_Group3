---
title: "OxFord COVID-19 Data Exploration"
output: html_document
author: "Estefania Avila, Meitong Hu, Egle Klekere, Alla Polishchuk, Jingjing Zhang"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Source & Summary

OXFORD COVID-19 GOVERNMENT RESPONSE TRACKER: aims to track and compare government responses to the coronavirus outbreak worldwide rigorously and consistently. We can analyze how specific government measures affect outcomes in terms of COVID cases and deaths.
https://www.bsg.ox.ac.uk/research/research-projects/oxford-covid-19-government-response-tracker

#### 13 Measures Tracked by Oxford:

* S1_School closing
* S2_Workplace closing
* S3_Cancel public events
* S4_Close public transport
* S5_Public information campaigns
* S6_Restrictions on internal movement
* S7_International travel controls
* S8_Fiscal measures
* S9_Monetary measures
* S10_Emergency investment in health care
* S11_Investment in Vaccines
* S12_Testing framework
* S13_Contact tracing

OxCGRT collects publicly available information on 13 indicators of government response (S1-S13). Nine of the indicators (S1-S7, S12 and S13) take policies such as school closures, travel bans, etc. are recorded on an ordinal scale; the remainder (S8-S11) are financial indicators such as fiscal or monetary measures.

This endpoint provides JSON by with country stringency data, confirmed cases and deaths on a day by day basis as collected by our data collection team. The stringency_actual field is the daily calculated data. The stringency field is a convenience field for visualisations which holds previous day data (up to 7 days) if data in unavailable for a given day.

#### Other data in dataset:

* ConfirmedCases
* ConfirmedDeaths
* StringencyIndex

Oxford has a StringencyIndex that measures how stringent each government has reacted. I thought, maybe we can introduce Proactivity index - how many measures country has introduced before first ConfirmedCase and first ConfirmedDeath. I assume this affects the outcomes as well. Then one of our questiond would be: What has been more effective stringency or proactivity?

Interesting analysis of Oxford data:
https://www.bsg.ox.ac.uk/research/research-projects/oxford-covid-19-government-response-tracker?ref=researchstash

White Paper on Data:
https://www.bsg.ox.ac.uk/sites/default/files/2020-04/BSG-WP-2020-031-v4.0_0.pdf



## Data Exploration
### Read File
Read file in.Noticed it has a lot of "Notes" columns used to supply source of change in variable.

```{r ,}
data = read.csv("OxCGRT_Download_080420_161822_Full.csv")
names(data)
```



#### Get Top 30 Countries
Top 30 is based on the number of Confirmed Cases on 04-08-2020. This can be modified.
```{r ,}
# look at the rows with the date 2020-04-08
data_0408 = subset(data, data$Date == 20200408)
# order data in descending order based on num cases and deaths
data_0408 = data_0408[order(-data_0408$ConfirmedCases, -data_0408$ConfirmedDeaths),]

# take the levels of first 30 rows of the CountryName column
top30 = levels(factor(head(data_0408,30)$CountryName))
top30
```

#### Filter data to only include Top 30 Countries
```{r ,}
# take the subset of data related to top 30 countries
df_top30 = subset(data, CountryName %in% top30)
df_top30 = subset(df_top30, df_top30$Date <= 20200408)
# drop unused levels from all factors
df_top30[] = lapply(df_top30, function(x) if(is.factor(x)) factor(x) else x)
```

#### Separate or remove excess columns
The Notes and General columns do not pertain to our prediction model. We will also only be using the Display Stringency Index as it is more complete.
```{r ,}
# find columns with Notes or General in name
Notes = c(grep( "Notes" , names( df_top30 ) ))
General = c(grep( "General" , names( df_top30 ) ))
# save notes and general as separate df's
df_notes = subset(df_top30, select = Notes )
df_general = subset( df_top30, select = General )
# remove notes and general columns from main df
df_top30 = subset( df_top30, select = -c(Notes, General))

# remove duplicate stringency index
df_top30 = subset(df_top30, select = -c(StringencyIndex))

str(df_top30)
summary(df_top30)
df = df_top30
```

#### Deal with NAs and NULLs
For most if not all measures, NA or NULL values were replaced with the most recent non-zero value for that country when possible, else zero
```{r ,}
#
```

#### Dealing with General vs Targetted
Data includes targeted and general measures. Should we be treating them differently?
```{r ,}
#
```


### Flatten Data
#### List of Dates of Interest
Retrieving every 7th day since Jan 1.
```{r ,}
# turn date column into date format and remove duplicate dates
df$Date <- as.Date(as.character(df$Date),"%Y%m%d")
dates = sort(unique(df$Date, incomparables = FALSE))

# extract every 7th date
dates = dates[seq(1, length(dates), 7)]
dates
```
#### Separate Flattening Columns
Some columns are informational and do not need to be flattened. Some measures need to be summed to that point. Others can just take the face value?
```{r ,}
info = c("Date", "CountryName", "CountryCode", "ConfirmedCases", "ConfirmedDeaths") #, "StringencyIndexForDisplay", "X")
measures = names(df)[!(names(df) %in% info)]
measures
```
#### Flatten Data into new DataFrame
```{r ,}
# create empty data frame
df_flat <- data.frame(Date=as.Date(character()),
                 CountryName=character(), 
                 CountryCode=character(),
                 S1_School.closing = integer(),
                 S2_Workplace.closing = integer(),
                 S3_Cancel.public.events = integer(),
                 S4_Close.public.transport = integer(),
                 S5_Public.information.campaigns = integer(),
                 S6_Restrictions.on.internal.movement = integer(),
                 S7_International.travel.controls = integer(),
                 S8_Fiscal.measures = double(),
                 S9_Monetary.measures = double(),
                 S10_Emergency.investment.in.health.care = double(),
                 S11_Investment.in.Vaccines = double(),
                 S12_Testing.framework = integer(),
                 S13_Contact.tracing = integer(),
                 StringencyIndexForDisplay = double(),
                 ConfirmedCases = integer(),
                 ConfirmedDeaths = integer(),
                 stringsAsFactors=FALSE) 
str(df)
str(df_flat)

df_flat <- rbind(df_flat, data.frame(Date=as.Date("1993-03-01"),
                                     CountryName="country",
                                     CountryCode ="cc",
                                     S1_School.closing = 1,
                                     S2_Workplace.closing = 2,
                                     S3_Cancel.public.events = 3,
                                     S4_Close.public.transport = 4,
                                     S5_Public.information.campaigns = 5,
                                     S6_Restrictions.on.internal.movement = 6,
                                     S7_International.travel.controls = 7.1,
                                     S8_Fiscal.measures = 8.1,
                                     S9_Monetary.measures = 9.1,
                                     S10_Emergency.investment.in.health.care = 10.1,
                                     S11_Investment.in.Vaccines = 11.1,
                                     S12_Testing.framework = 12,
                                     S13_Contact.tracing = 13,
                                     StringencyIndexForDisplay = 14.1,
                                     ConfirmedCases = 15,
                                     ConfirmedDeaths = 16))


df_flat <- rbind(df_flat, c(as.Date("1993-03-01"),"cou", "ccc", 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15, 16))

# for each country in the top 30
for (country in top30) {
  # for each date in dates list
  for (date in dates) {
    # subset of data just up to that date and only for that country
    df_date = subset(df, CountryName == country & Date <= date)
    date_ = max(df_date$date, na.rm = TRUE)
    cc = levels(factor(df_date$CountryCode))
    cases = max(df_date$ConfirmedCases, na.rm = TRUE)
    deaths = max(df_date$ConfirmedDeaths, na.rm = TRUE)
    
    df_measures = df_date[measures]
    
    if (country == "United States") {
      print(date_)
      print(typeof(date_))
      #print(cc)
      #print(cases)
      cols = colSums(df_measures, na.rm = TRUE)
      df_flat <- rbind(df_flat, data.frame(Date=date_,
                                           CountryName=country,
                                           CountryCode =cc,
                                           S1_School.closing = cols['S1_School.closing'],
                                           S2_Workplace.closing = cols['S2_Workplace.closing'],
                                           S3_Cancel.public.events = cols['S3_Cancel.public.events'],
                                           S4_Close.public.transport = cols['S4_Close.public.transport'],
                                           S5_Public.information.campaigns = cols['S5_Public.information.campaigns'],
                                           S6_Restrictions.on.internal.movement = cols['S6_Restrictions.on.internal.movement'],
                                           S7_International.travel.controls = cols['S7_International.travel.controls'],
                                           S8_Fiscal.measures = cols['S8_Fiscal.measures'],
                                           S9_Monetary.measures = cols['S9_Monetary.measures'],
                                           S10_Emergency.investment.in.health.care = cols['S10_Emergency.investment.in.health.care'],
                                           S11_Investment.in.Vaccines = cols['S11_Investment.in.Vaccines'],
                                           S12_Testing.framework = cols['S12_Testing.framework'],
                                           S13_Contact.tracing = cols['S13_Contact.tracing'],
                                           StringencyIndexForDisplay = cols['StringencyIndexForDisplay'],
                                           ConfirmedCases = cases,
                                           ConfirmedDeaths = deaths))
      #print(cols['S1_School.closing'])
      #print(cols)
    }
  }
}

df<-data.frame(1,2)
names(df)<-c("hello","goodbye")
str(df)

newdf2<-rbind(df, data.frame(hello=2, goodbye=3))
str(newdf2)

# sum all previous up to date
# add to new df
```

```{r}

### We do our prediction based on the data on 20200408
df_20200408<-subset(data,select=c("CountryName","Date","ConfirmedCases","ConfirmedDeaths"))
df_20200408<-subset(df_20200408,Date=="20200408")
df_20200408$DeathRate<-round(df_20200408$ConfirmedDeaths/df_20200408$ConfirmedCases,3)
str(df_20200408)
install.packages("lubridate")
library(lubridate)
df_20200408$Date<- ymd(df_20200408[, 2]) #Converting integer to date formate

### Try to create some variables showing how many days those countries have closed schools, governments and workplace. TBC.
library(dplyr)
df_school<-subset(data,select="CountryName")
df_school$CloseSchool<-ifelse(data$S1_School.closing==2,data$Date,NA)


```



### Explore Notes Columns
To explore the notes data, we just peaked into one of the columns to see what kind of announcements they are using.
```{r ,}
names(df_notes)
str(df_notes)
levels(df_notes$S1_Notes)[1:5]
```

### Explore Genral Columns
To explore the general, we just peaked into one of the columns to see what kind of announcements they are using.
```{r ,}
names(df_general)
str(df_general)
levels(df_general$S1_IsGeneral)[1:20]
```

## Potential Questions to Explore:

* Which measures were most effective for which countries?
* Predict number of cases? deaths? 